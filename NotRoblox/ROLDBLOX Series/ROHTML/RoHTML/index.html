<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoHTML</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* This is critical for the AHK overlay. It removes the default
           white page background, allowing any transparency to show through. */
        html, body {
            background: transparent !important;
        }

        #debug-cursor {
            position: fixed;
            pointer-events: none;
            z-index: 999999;
            background-image: url('content/textures/ArrowFarCursor.png');
            background-repeat: no-repeat;
            background-position: center;
            transform: translate(-50%, -50%);
            /* Hide cursor initially until AHK moves it */
            display: none;
        }
        #debug-cursor.hovering {
            background-image: url('content/textures/ArrowCursor.png');
        }
        /* Hide default cursor everywhere */
        * {
            cursor: none !important;
        }
    </style>
</head>
<body>
    <div id="effect-layer"></div>
    <div id="debug-cursor"></div>
    <div id="loading-screen">
        <div id="info-frame">
            <div id="place-label"></div>
            <div id="creator-label"></div>
        </div>
        <div id="graphics-frame">
            <img id="loading-image" src="content/textures/loading/loadingCircle.png" alt="Loading...">
            <div id="loading-text">Loading...</div>
        </div>
    </div>

    <script>
        // This function will be called by the AutoHotkey script
        let lastHoveredElement = []; // To track hover state
        const cursor = document.getElementById('debug-cursor'); // Global cursor reference

        // Load cursor images to get their natural dimensions
        const farCursor = new Image();
        farCursor.src = 'content/textures/ArrowFarCursor.png';
        const nearCursor = new Image();
        nearCursor.src = 'content/textures/ArrowCursor.png';

        // Once images are loaded, set the cursor size
        Promise.all([
            new Promise(resolve => farCursor.onload = resolve),
            new Promise(resolve => nearCursor.onload = resolve)
        ]).then(() => {
            cursor.style.width = Math.max(farCursor.width, nearCursor.width) + 'px';
            cursor.style.height = Math.max(farCursor.height, nearCursor.height) + 'px';
            cursor.style.backgroundSize = '100% 100%';
            cursor.style.display = 'block'; // Show cursor after images are loaded
        });

        // Optimized mouse listener to prevent lag
        let latestMouseX = 0;
        let latestMouseY = 0;
        let ticking = false;

        document.addEventListener('mousemove', function(e) {
            latestMouseX = e.clientX;
            latestMouseY = e.clientY;
            
            if (!ticking) {
                window.requestAnimationFrame(function() {
                    if (cursor) {
                        // Update cursor position
                        cursor.style.left = latestMouseX + 'px';
                        cursor.style.top = latestMouseY + 'px';

                        // Update hover state efficiently
                        const elements = getElementsAtPointManually(latestMouseX, latestMouseY);
                        cursor.classList.toggle('hovering', elements.length > 0);
                    }
                    ticking = false;
                });
                
                ticking = true;
            }
        }, { passive: true }); // Use a passive listener for better performance

        function getElementsAtPointManually(x, y) {
            const elements = document.querySelectorAll(
                'button, [role="button"], .topbar-button, .settings-tab, .setting-row, ' +
                '.slider-button, .selector-button, .slider-step, .image-button, .bottom-bar-button, ' +
                '.confirmation-button, .slider-steps-container, .selector-text-container'
            );
            const found = [];
            // Iterate in reverse to check top-most elements first
            for (let i = elements.length - 1; i >= 0; i--) {
                const el = elements[i];
                const rect = el.getBoundingClientRect();
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    found.push(el);
                }
            }
            return found;
        }

        function handleAhkInput(dataString) {
            const parts = dataString.split(';');
            const eventType = parts[0];

            if (eventType === 'mouse') {
                const action = parts[1];
                const x = parseInt(parts[3], 10);
                const y = parseInt(parts[4], 10);

                // Update cursor position immediately
                if (cursor) {
                    cursor.style.left = x + 'px';
                    cursor.style.top = y + 'px';
                    
                    // Update hover state efficiently
                    const elements = getElementsAtPointManually(x, y);
                    const isHovering = elements.length > 0;
                    cursor.classList.toggle('hovering', isHovering);
                }

                if (action === 'wheel') {
                    const delta = parseInt(parts[2], 10);
                    const targets = getElementsAtPointManually(x, y);
                    const primaryTarget = targets[0] || document.body;

                    // Dispatch wheel event immediately
                    primaryTarget.dispatchEvent(new WheelEvent('wheel', {
                        deltaY: -delta,
                        clientX: x,
                        clientY: y,
                        bubbles: true
                    }));
                    return;
                }

                const buttonName = parts[2];
                const currentElements = getElementsAtPointManually(x, y);
                const primaryTarget = currentElements[0];

                // Optimized hover state management
                if (action === 'move') {
                    // Only update if hover state actually changed
                    const toUnhover = lastHoveredElement.filter(el => !currentElements.includes(el));
                    const toHover = currentElements.filter(el => !lastHoveredElement.includes(el));

                    if (toUnhover.length > 0 || toHover.length > 0) {
                        toUnhover.forEach(el => el.classList.remove('hover'));
                        toHover.forEach(el => el.classList.add('hover'));
                        lastHoveredElement = currentElements;
                    }
                }

                if (!primaryTarget) {
                    return;
                }
                
                const eventName = 'mouse' + action;
                const buttonId = buttonName === "left" ? 0 : (buttonName === "right" ? 2 : (buttonName === "middle" ? 1 : 0));
                
                const eventOptions = {
                    bubbles: true,
                    cancelable: true,
                    view: window,
                    clientX: x,
                    clientY: y,
                    screenX: x,
                    screenY: y,
                    button: buttonId,
                    buttons: buttonName === "left" ? 1 : (buttonName === "right" ? 2 : (buttonName === "middle" ? 4 : 0))
                };

                // Dispatch events immediately
                primaryTarget.dispatchEvent(new MouseEvent(eventName, eventOptions));

                if (action === 'up') {
                    primaryTarget.dispatchEvent(new MouseEvent('click', eventOptions));
                }

            } else if (eventType === 'key') {
                const action = parts[1];
                const keyName = parts[2];
                const eventName = 'key' + action;
                
                // Dispatch keyboard events immediately
                document.body.dispatchEvent(new KeyboardEvent(eventName, {
                    key: keyName,
                    bubbles: true,
                    cancelable: true,
                    view: window
                }));
            }
        }
    </script>
    <div id="topbar">
        <div id="topbar-left">
            <div id="menu-button" class="topbar-button"></div>
            <div id="chat-button" class="topbar-button"></div>
            <div id="backpack-button" class="topbar-button"></div>
        </div>

        <div id="topbar-right">
            <div id="player-info">
                <div id="username"></div>
                <div id="account-age-text"></div>
            </div>
        </div>
    </div>

    <div id="settings-clipping-shield">
        <div id="settings-shield">
            <div id="settings-menu-container">
                <div id="settings-hub-bar">
                    <div id="settings-tabs-container">
                        <button class="settings-tab active" data-page="players">
                            <img id="players-tab-icon" class="tab-icon" src="content/textures/ui/Settings/MenuBarIcons/PlayersTabIcon.png" alt="Players">
                            <span class="tab-title">Players</span>
                            <div class="tab-highlight"></div>
                        </button>
                        <button class="settings-tab" data-page="settings">
                            <img id="settings-tab-icon" class="tab-icon" src="content/textures/ui/Settings/MenuBarIcons/GameSettingsTab.png" alt="Settings">
                            <span class="tab-title">Settings</span>
                            <div class="tab-highlight"></div>
                        </button>
                        <button class="settings-tab" data-page="report">
                            <img id="report-tab-icon" class="tab-icon" src="content/textures/ui/Settings/MenuBarIcons/ReportAbuseTab.png" alt="Report">
                            <span class="tab-title">Report</span>
                            <div class="tab-highlight"></div>
                        </button>
                        <button class="settings-tab" data-page="help">
                            <img id="help-tab-icon" class="tab-icon" src="content/textures/ui/Settings/MenuBarIcons/HelpTab.png" alt="Help">
                            <span class="tab-title">Help</span>
                            <div class="tab-highlight"></div>
                        </button>
                        <button class="settings-tab" data-page="record">
                            <img id="record-tab-icon" class="tab-icon" src="content/textures/ui/Settings/MenuBarIcons/RecordTab.png" alt="Record">
                            <span class="tab-title">Record</span>
                            <div class="tab-highlight"></div>
                        </button>
                    </div>
                </div>
                <div id="page-view-clipper">
                    <div id="page-view">
                        <div class="settings-page" id="page-players">
                            <div class="settings-scroller">
                                <div class="player-list-container">
                                    <!-- Player Row based on your screenshots -->
                                    <div class="player-label-unknown">
                                        <div class="player-icon"></div>
                                        <div class="player-name-label" id="main-player-name">unknown</div>
                                    </div>
                                    <!-- Add more player rows here as needed -->
                                </div>
                            </div>
                        </div>
                        <div class="settings-page" id="page-settings">
                            <div class="settings-scroller">
                                <!-- Shift Lock Switch -->
                                <div class="setting-row" data-setting="shiftLockSwitch">
                                    <span class="setting-label">Shift Lock Switch</span>
                                    <div class="setting-control">
                                        <div class="selector-control" id="shift-lock-selector" data-options='["On", "Off"]'></div>
                                    </div>
                                </div>
                                <!-- Camera Mode -->
                                <div class="setting-row" data-setting="cameraMode">
                                    <span class="setting-label">Camera Mode</span>
                                    <div class="setting-control">
                                        <div class="selector-control" id="camera-mode-selector" data-options='["Default (Classic)", "Classic", "Follow"]'></div>
                                    </div>
                                </div>
                                 <!-- Movement Mode -->
                                 <div class="setting-row" data-setting="movementMode">
                                    <span class="setting-label">Movement Mode</span>
                                    <div class="setting-control">
                                        <div class="selector-control" id="movement-mode-selector" data-options='["Default (Keyboard)", "Keyboard + Mouse", "Click to Move"]'></div>
                                    </div>
                                </div>
                                <!-- Camera Sensitivity -->
                                <div class="setting-row" data-setting="cameraSensitivity">
                                    <span class="setting-label">Camera Sensitivity</span>
                                    <div class="setting-control">
                                        <div class="slider-control" id="camera-sensitivity-slider"></div>
                                    </div>
                                </div>
                                <!-- Volume -->
                                <div class="setting-row" data-setting="volume">
                                    <span class="setting-label">Volume</span>
                                    <div class="setting-control">
                                        <div class="slider-control" id="volume-slider"></div>
                                    </div>
                                </div>
                                <!-- Fullscreen -->
                                <div class="setting-row" data-setting="fullscreen">
                                    <span class="setting-label">Fullscreen</span>
                                    <div class="setting-control">
                                        <div class="selector-control" id="fullscreen-selector" data-options='["On", "Off"]'></div>
                                    </div>
                                </div>
                                <!-- Graphics Mode -->
                                <div class="setting-row" data-setting="graphicsMode">
                                    <span class="setting-label">Graphics Mode</span>
                                    <div class="setting-control">
                                        <div class="selector-control" id="graphics-mode-selector" data-options='["Automatic", "Manual"]'></div>
                                    </div>
                                </div>
                                <!-- Graphics Quality -->
                                <div class="setting-row" data-setting="graphicsQuality">
                                    <span class="setting-label">Graphics Quality</span>
                                    <div class="setting-control">
                                        <div class="slider-control" id="graphics-quality-slider"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="settings-page" id="page-report">
                            <div class="settings-scroller">
                                <div class="setting-row">
                                    <span class="setting-label">Game or Player?</span>
                                    <div class="setting-control">
                                        <div class="selector-control" id="report-type-selector" data-options='["Game", "Player"]'></div>
                                    </div>
                                </div>
                                <div class="setting-row" id="report-which-player-row">
                                    <span class="setting-label">Which Player?</span>
                                    <div class="setting-control">
                                        <button id="report-which-player-dropdown" class="image-button dropdown-button">
                                            <span class="dropdown-button-text">Choose One</span>
                                            <div class="dropdown-button-icon"></div>
                                        </button>
                                    </div>
                                </div>
                                <div class="setting-row">
                                    <span class="setting-label">Type of Abuse</span>
                                    <div class="setting-control">
                                        <button id="report-abuse-type-dropdown" class="image-button dropdown-button">
                                            <span class="dropdown-button-text">Choose One</span>
                                            <div class="dropdown-button-icon"></div>
                                        </button>
                                    </div>
                                </div>
                                <!-- Description Text Area -->
                                <div class="setting-row report-description-row">
                                    <div class="setting-control">
                                        <textarea id="report-description-textarea" rows="4" placeholder="Short Description (Optional)"></textarea>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="setting-row report-submit-row">
                                    <button id="report-submit-button" class="image-button" disabled>Submit</button>
                                </div>
                            </div>
                        </div>
                        <div class="settings-page" id="page-help">
                            <div class="help-content-container">
                                <div class="help-row">
                                    <div class="help-group" id="help-char-move">
                                        <div class="help-group-title">Character Movement</div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Move Forward</span>
                                            <span class="keybind-key">W/Up Arrow</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Move Backward</span>
                                            <span class="keybind-key">S/Down Arrow</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Move Left</span>
                                            <span class="keybind-key">A/Left Arrow</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Move Right</span>
                                            <span class="keybind-key">D/Right Arrow</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Jump</span>
                                            <span class="keybind-key">Space</span>
                                        </div>
                                    </div>
                                    <div class="help-group" id="help-accessories">
                                        <div class="help-group-title">Accessories</div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Equip Tools</span>
                                            <span class="keybind-key">1,2,3...</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Unequip Tools</span>
                                            <span class="keybind-key">1,2,3...</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Drop Tool</span>
                                            <span class="keybind-key">Backspace</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Use Tool</span>
                                            <span class="keybind-key">Left Mouse Button</span>
                                        </div>
                                    </div>
                                    <div class="help-group" id="help-misc">
                                        <div class="help-group-title">Misc</div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Screenshot</span>
                                            <span class="keybind-key">Print Screen</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Record Video</span>
                                            <span class="keybind-key">F12</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Dev Console</span>
                                            <span class="keybind-key">F9</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Mouselock</span>
                                            <span class="keybind-key">Shift</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Graphics Level</span>
                                            <span class="keybind-key">F10</span>
                                        </div>
                                         <div class="keybind-row">
                                            <span class="keybind-action">Fullscreen</span>
                                            <span class="keybind-key">F11</span>
                                        </div>
                                         <div class="keybind-row">
                                            <span class="keybind-action">Perf. Stats</span>
                                            <span class="keybind-key">Ctrl + Shift + F7</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="help-row">
                                    <div class="help-group" id="help-camera">
                                        <div class="help-group-title">Camera Movement</div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Rotate</span>
                                            <span class="keybind-key">Right Mouse Button</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Zoom In/Out</span>
                                            <span class="keybind-key">Mouse Wheel</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Zoom In</span>
                                            <span class="keybind-key">I</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Zoom Out</span>
                                            <span class="keybind-key">O</span>
                                        </div>
                                    </div>
                                    <div class="help-group" id="help-menu">
                                        <div class="help-group-title">Menu Items</div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">ROBLOX Menu</span>
                                            <span class="keybind-key">ESC</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Backpack</span>
                                            <span class="keybind-key">~</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Playerlist</span>
                                            <span class="keybind-key">TAB</span>
                                        </div>
                                        <div class="keybind-row">
                                            <span class="keybind-action">Chat</span>
                                            <span class="keybind-key">/</span>
                                        </div>
                                    </div>
                                    <div class="help-group"></div> <!-- Empty group for spacing -->
                                </div>
                            </div>
                        </div>
                        <div class="settings-page" id="page-record">
                            <div class="settings-scroller">
                                <!-- Screenshot Section -->
                                <div class="record-title-row">
                                    <div class="record-title">Screenshot</div>
                                </div>
                                <div class="record-body-row">
                                    <div class="record-description">By clicking the 'Take Screenshot' button, the menu will close and take a screenshot and save it to your computer.</div>
                                </div>
                                <div class="record-button-row screenshot-button-row">
                                    <button class="image-button" id="take-screenshot-button">Take Screenshot</button>
                                </div>
                        
                                <!-- Video Section -->
                                <div class="record-title-row">
                                    <div class="record-title">Video</div>
                                </div>
                                <div class="record-body-row">
                                    <div class="record-description">By clicking the 'Record Video' button, the menu will close and start recording your screen.</div>
                                </div>
                                <div class="record-button-row">
                                    <button class="image-button" id="record-video-button">Record Video</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="bottom-button-frame">
                    <button id="reset-char-button" class="bottom-bar-button">
                        <img class="hint-icon" src="content/textures/ui/Settings/Help/ResetIcon.png" alt="Reset">
                        <span>Reset Character</span>
                    </button>
                    <button id="leave-game-button" class="bottom-bar-button">
                        <img class="hint-icon" src="content/textures/ui/Settings/Help/LeaveIcon.png" alt="Leave">
                        <span>Leave Game</span>
                    </button>
                    <button id="resume-button" class="bottom-bar-button">
                        <img class="hint-icon" src="content/textures/ui/Settings/Help/EscapeIcon.png" alt="Resume">
                        <span>Resume Game</span>
                    </button>
                </div>
            </div>

            <!-- Confirmation Pages -->
            <div id="reset-character-page" class="confirmation-page">
                <div class="confirmation-text">Are you sure you want to reset your character?</div>
                <div class="confirmation-buttons">
                    <button id="reset-confirm-button" class="confirmation-button selected">Reset</button>
                    <button id="reset-cancel-button" class="confirmation-button">Don't Reset</button>
                </div>
            </div>

            <div id="leave-game-page" class="confirmation-page">
                <div class="confirmation-text">Are you sure you want to leave the game?</div>
                <div class="confirmation-buttons">
                    <button id="leave-confirm-button" class="confirmation-button selected">Leave</button>
                    <button id="leave-cancel-button" class="confirmation-button">Don't Leave</button>
                </div>
            </div>

            <div id="thanks-game-page" class="confirmation-page">
                <div class="confirmation-text">Thanks for your report! Our moderators will review the place and make a determination.</div>
                <div class="confirmation-buttons">
                    <button id="thanks-game-ok-button" class="confirmation-button selected">Ok</button>
                </div>
            </div>
            
            <div id="thanks-player-page" class="confirmation-page">
                <div class="confirmation-text">Thanks for your report! Our moderators will review the chat logs and evaluate what happened.</div>
                <div class="confirmation-buttons">
                    <button id="thanks-player-ok-button" class="confirmation-button selected">Ok</button>
                </div>
            </div>

             <!-- Version Container -->
            <div id="version-container">
                <div id="server-version-label" class="version-label"></div>
                <div id="environment-label" class="version-label"></div>
                <div id="client-version-label" class="version-label"></div>
            </div>

            <!-- Report Abuse Fullscreen Dropdown -->
            <div id="report-dropdown-fullscreen-frame" class="hidden">
                <div id="report-dropdown-selection-frame">
                    <div id="report-dropdown-scrolling-frame">
                        <!-- Options populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- The hurt overlay for when health is low -->
    <div id="hurt-overlay"></div>

    <script src="config.js"></script>
    <script src="js/init.js"></script>
    <script src="js/settings.js"></script>
    <script src="settings_manager.js"></script>
    <script src="js/effects.js"></script>
    <script src="js/topbar.js"></script>
    <script src="js/confirmation.js"></script>
    <script src="js/report.js"></script>
    <script src="version_data.js"></script>
    <script src="js/version.js"></script>
    <script src="js/background.js"></script>
    <script src="js/input_handler.js"></script>
    <script src="js/loading.js"></script>
    <script src="js/settings_handler.js"></script>
    <script src="performance_monitor.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.ROHTML_CONFIG && window.ROHTML_CONFIG.username) {
                const playerNameElement = document.getElementById('main-player-name');
                if (playerNameElement) {
                    playerNameElement.textContent = window.ROHTML_CONFIG.username;
                }
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let lastSentState = null;

            document.addEventListener('mousemove', (event) => {
                const target = event.target;
                const isInteractive = target && target.closest('.interactive');
                const currentState = !!isInteractive;

                if (currentState !== lastSentState) {
                    // Check that the webview API is available before posting a message
                    if (window.chrome && window.chrome.webview) {
                        window.chrome.webview.postMessage({ interactive: currentState });
                    }
                    lastSentState = currentState;
                }
            }, true); // Use capture to get the event on the way down.
        });

        function flashColor(color) {
            document.body.style.transition = 'background-color 0.1s ease';
            document.body.style.backgroundColor = color;
            setTimeout(() => {
                document.body.style.backgroundColor = 'transparent';
            }, 150);
        }
    </script>
    <script>
        function createHoverStyles() {
            const generatedStyles = [];
            // Go through all loaded stylesheets
            for (const sheet of document.styleSheets) {
                try {
                    if (!sheet.cssRules) continue;
                    // Go through all the rules in a stylesheet
                    for (const rule of sheet.cssRules) {
                        // We only care about style rules with a selector that includes :hover
                        if (rule.type === CSSRule.STYLE_RULE && rule.selectorText.includes(':hover')) {
                            // Create a new selector by replacing all instances of :hover with .hover
                            const newSelector = rule.selectorText.replace(/:hover/g, '.hover');
                            const styleBlock = rule.style.cssText;

                            if (newSelector && styleBlock) {
                                generatedStyles.push(`${newSelector} { ${styleBlock} }`);
                            }
                        }
                    }
                } catch (e) {
                    console.warn(`Could not process stylesheet: ${sheet.href}`, e);
                }
            }

            // If we found any hover styles, create a new <style> element and add them
            if (generatedStyles.length > 0) {
                const styleEl = document.createElement('style');
                styleEl.id = 'dynamic-hover-styles';
                styleEl.textContent = generatedStyles.join('\n');
                document.head.appendChild(styleEl);
                console.log('Successfully generated', generatedStyles.length, 'hover rules.');
            }
        }

        // Run the converter after the page and all its resources have fully loaded.
        window.addEventListener('load', createHoverStyles);
    </script>
</body>
</html>
